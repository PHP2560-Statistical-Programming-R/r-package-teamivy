---
title: "Webscraping Live Betting Odds"
author: "Derrick Yam"
date: "December 6, 2017"
output: html_document
---

##Load Libraries
```{r}
library(rvest)
library(pipeR)
library(knitr)
library(xml2)
library(htmltab)
library(readxl)
library(tidyr)
library(lubridate)
library(dplyr)
library(stringr)
options(tibble.width = Inf)
```


##Look into live webscraping

```{r}
##Spreads Tables
url <-  "http://www.donbest.com/nba/odds/spreads/20171204.html"

SpreadsTable <- url %>%
    read_html %>%
    html_nodes(xpath = '//*[@id="oddsHolder"]/div[1]/table') %>%
    html_table(header = F, fill =T) %>%
    data.frame() %>%
    tbl_df()

head(SpreadsTable)
SpreadsTable <- SpreadsTable[-1, ]

names(SpreadsTable) <- SpreadsTable[1,]
SpreadsTable <- SpreadsTable[-1, ]

SpreadsTable <- SpreadsTable %>% 
  select(Rot, Opener, Team, Time, Bovada, Pinnacle, Mirage)

#Rot works
temp <- SpreadsTable %>% 
  mutate(Rot1 = as.character(Rot),
         Rot2 = as.character(Rot))

temp$Rot1 <- str_sub(temp$Rot1, 1, 3)
temp$Rot2 <- str_sub(temp$Rot2, 4, 6)

#Opener
#We need to create a regex pattern
temp <- SpreadsTable %>% 
  mutate(OS = Opener,
         ML = Opener)

library(stringi)
library(rebus)
pattern <- START %R% or("+", "-") %R% one_or_more(DGT) %R% optional(".") %R%
  zero_or_more(DGT) %R% or("+", "-") %R% one_or_more(DGT) %R% or("+", "-")
, "[+-]", "[:digit:]+", "[+-]"
pattern <- str_c("[+-]", "[:digit:]+", ".?", "[:digit:]*","[\\s]")
temp$OS <- str_match(temp$OS, pattern)
funct.salary <- function(team, year){
  urltable <- paste0("https://widgets.sports-reference.com/wg.fcgi?css=1&site=bbr&url=%2Fteams%2F",
                     team, "%2F", year, ".html&div=div_salaries2")
  
  Salary <- htmltab(urltable) %>% 
    mutate(Team = team) %>% 
    rename(Player = V1) %>% 
    dplyr::select(-Rk)

  return(Salary)
}

Salary <- funct.salary("CLE", "2017")


##MoneyLine Tables
url <-  "http://www.donbest.com/nba/odds/money-lines/20171203.html"

MoneyLineTable <- url %>%
    read_html %>%
    html_nodes(xpath = '//*[@id="oddsHolder"]/div[1]/table') %>%
    html_table(header = T, fill =T) %>%
    data.frame() %>%
    tbl_df()

head(SpreadsTable)

```


##Learning Javascript scraping
From: https://www.r-bloggers.com/short-r-tutorial-scraping-javascript-generated-data-with-r/
From: https://www.r-bloggers.com/scraping-javascript-rendered-web-content-using-r/
From: https://www.r-bloggers.com/web-scraping-javascript-rendered-sites/

